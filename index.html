<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å›¾ä¹¦å€Ÿè¿˜ç³»ç»Ÿ</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 30px auto; }
    h1 { text-align: center; }
    input, button, select { font-size: 1.1em; padding: 8px; margin-top: 10px; width: 100%; }
    #result, #log { margin-top: 20px; font-size: 1.1em; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>ğŸ“š å›¾ä¹¦å€Ÿè¿˜ç³»ç»Ÿ</h1>
  <input type="text" id="bookName" placeholder="è¯·è¾“å…¥ä¹¦å">
  <button onclick="searchBook()">æŸ¥è¯¢å›¾ä¹¦</button>

  <div id="result"></div>

  <div id="borrowSection" class="hidden">
    <h3>å€Ÿé˜…äººä¿¡æ¯</h3>
    <input type="text" id="borrower" placeholder="å€Ÿé˜…äººå§“å">
    <input type="text" id="idNumber" placeholder="è¯ä»¶å·">
    <button onclick="borrowBook()">å€Ÿä¹¦</button>
    <button onclick="returnBook()">è¿˜ä¹¦</button>
  </div>

  <div id="log"></div>

  <script>
    let books = [
      { name: "è‡ªç„¶ç§‘å­¦æ¦‚è®º", status: "å¯å€Ÿ", number: 3 },
      { name: "æœ‰æœºåŒ–å­¦", status: "å¯å€Ÿ", number: 2 },
      { name: "å›¾ä¹¦é¦†ç®¡ç†å­¦", status: "ä¸å¯å€Ÿ", number: 0 }
    ];
    let selectedBook = null;

    const scriptURL = 'https://script.google.com/macros/s/AKfycbzHJnzyGBFeY7sa9SDdBiRwnR-8BGcaGUsFHQqwUOGrXSUzpCouJknHI8sHt44NzcbNwA/exec';

    function searchBook() {
      const name = document.getElementById('bookName').value.trim();
      const resultDiv = document.getElementById('result');
      const borrowDiv = document.getElementById('borrowSection');
      const logDiv = document.getElementById('log');
      logDiv.innerHTML = '';
      borrowDiv.classList.add('hidden');

      if (!name) {
        resultDiv.innerHTML = 'â— è¯·è¾“å…¥ä¹¦å';
        return;
      }

      const book = books.find(b => b.name.includes(name));
      if (book) {
        selectedBook = book;
        if (book.status === 'å¯å€Ÿ' && book.number > 0) {
          resultDiv.innerHTML = `âœ… å¯å€Ÿï¼š${book.name}ï¼ˆå‰©ä½™ ${book.number} æœ¬ï¼‰`;
          borrowDiv.classList.remove('hidden');
        } else {
          resultDiv.innerHTML = `âŒ æš‚ä¸å¯å€Ÿï¼š${book.name}ï¼ˆå‰©ä½™ ${book.number} æœ¬ï¼‰`;
        }
      } else {
        resultDiv.innerHTML = 'âŒ æœªæ‰¾åˆ°è¯¥ä¹¦';
      }
    }

    function borrowBook() {
      handleBorrowReturn('å€Ÿä¹¦');
    }

    function returnBook() {
      handleBorrowReturn('è¿˜ä¹¦');
    }

    function handleBorrowReturn(action) {
      const name = document.getElementById('borrower').value.trim();
      const id = document.getElementById('idNumber').value.trim();
      const logDiv = document.getElementById('log');

      if (!selectedBook) {
        logDiv.innerHTML = 'â— è¯·å…ˆæŸ¥è¯¢å›¾ä¹¦';
        return;
      }

      if (!name || !id) {
        logDiv.innerHTML = 'â— è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
        return;
      }

      // æ›´æ–°åº“å­˜
      if (action === 'å€Ÿä¹¦' && selectedBook.number > 0) {
        selectedBook.number -= 1;
      } else if (action === 'è¿˜ä¹¦') {
        selectedBook.number += 1;
      }

      document.getElementById('result').innerHTML = `ğŸ“– å½“å‰åº“å­˜ï¼š${selectedBook.number} æœ¬`;

      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      logDiv.innerHTML = `âœ… ${action}æˆåŠŸï¼š${selectedBook.name}<br>ğŸ“Œ å€Ÿé˜…äººï¼š${name}<br>ğŸ†” è¯ä»¶å·ï¼š${id}`;

      // æäº¤åˆ° Google è¡¨æ ¼
      const formData = new FormData();
      formData.append("ä¹¦å", selectedBook.name);
      formData.append("æ“ä½œç±»å‹", action);
      formData.append("å€Ÿé˜…äººå§“å", name);
      formData.append("è¯ä»¶å·", id);

      fetch(scriptURL, {
        method: 'POST',
        body: formData
      }).then(response => {
        console.log("âœ… æ•°æ®å·²ä¿å­˜è‡³åå°");
      }).catch(error => {
        console.error("âŒ æäº¤å¤±è´¥", error);
      });

      // æ¸…ç©ºè¾“å…¥æ¡†
      document.getElementById('borrower').value = '';
      document.getElementById('idNumber').value = '';
    }
  </script>
</body>
</html>
